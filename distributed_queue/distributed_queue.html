<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script type="text/javascript" src="../d3-3.5.2.min.js"></script>
  <style type="text/css">
  .button {
    cursor: pointer;
  }
  </style>
</head>
<body>

<svg id="svg"></svg>

<script type="text/javascript">
  var queueCount = 10

  var colors = d3.scale.category10()
  var nextId = 0

  var svg = d3.select("svg")
  svg.attr("width", 900)
  svg.attr("height", 500)
  svg.style("background", "#eee")


  svg.append("text")
    .text("Add 30")
    .attr("x", 800)
    .attr("y", 16)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .style("fill", "black")

  buttons = svg.selectAll("rect.adder")
    .data([0,1,2,3,4,5,6,7,8,9])
    .enter()
    .append("rect")
      .attr("class", "adder")
      .attr("width", 60)
      .attr("height", 20)
      .attr("x", 770)
      .attr("y", function(d) { return d*30 + 30 })
      .style("stroke", "none")
      .style("fill", function(d) { return colors(d) })
      .on("click", function(d) {
        addPackets(30, d)
        redraw()
      })

  svg.append("text")
    .text("Enqueue Style")
    .attr("x", 60)
    .attr("y", 16)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .style("fill", "black")

  queueButtons = svg.selectAll("rect.queue")
    .data(["rotatingQueue", "randomQueue", "shuffleShard"])
    .enter()
      .append("g")
        .attr("class", "button")
        .attr("transform", function(d, i) { return "translate(10, " + (i * 30 + 30) + ")" })
        .on("click", function(d, i) {
          queuer = window[d]
        })

  queueButtons
    .append("rect")
      .attr("class", "queue")
      .attr("width", 120)
      .attr("height", 20)
      .style("stroke", "none")
      .style("fill", "#ccc")

  queueButtons
    .append("text")
      .text(function(d) { return d })
      .attr("x", 60)
      .attr("y", 16)
      .attr("text-anchor", "middle")
      .style("font-size", "16px")
      .style("fill", "white")


  var packets = []

  function rotatingQueue(id, ownerId) {
    return id % queueCount;
  }

  function randomQueue(nextId, ownerId) {
    return Math.floor(Math.random() * queueCount)
  }

  queuesForKey = {}

  function shuffleShard(nextId, key) {
    var queuesPerKey = 3
    var subQueueId = Math.floor(Math.random() * queuesPerKey)
    if (!queuesForKey[key]) {
      queuesForKey[key] = []
      while (queuesForKey[key].length < 3) {
        var candidate = Math.floor(Math.random() * queueCount)
        if (queuesForKey[key].indexOf(candidate) == -1) {
          queuesForKey[key].push(candidate)
        }
      }
    }
    return queuesForKey[key][subQueueId]
  }

  function addPackets(count, givenOwnerId) {
    if (packets.length + count > 500) { return } // Safety

    for(var i=0; i<count; i++) {
      ownerId = givenOwnerId == undefined ? Math.floor(Math.random() * 10) :  givenOwnerId
      nextId++
      var queue = queuer(nextId, ownerId)
      packets.push({id: nextId, ownerId: ownerId, queue: queue })
    }
  }

  function removePackets() {
    var newPackets = []
    for(i=0;i<packets.length;i++) {
      if (packets[i].position != 0) {
        newPackets.push(packets[i])
      }
    }
    packets = newPackets
  }

  function redraw() {
    positions = {}

    // Anntotate
    packets.forEach(function(packet) {
      if (positions[packet.queue] === undefined) {
        positions[packet.queue] = 0
      }
      packet.position = positions[packet.queue]++
    })

    var rects = svg.selectAll("rect.packet")
      .data(packets, function(d) { return d.id })

    rects.enter()
      .append("rect")
        .attr("class", "packet")
        .attr("x", function(d) { return d.queue*30 + 300 })
        .attr("y", function(d) { return 0 })
        .attr("width", 10)
        .attr("height", 5)
        .style("opacity", 0)
        .style("stroke", "none")
        .style("fill", function(d) { return colors(d.ownerId) })
        .transition().ease("linear")
          .attr("y", function(d) { return 400 - d.position*7 })
          .style("opacity", 1)
    rects.transition().ease("linear")
      .attr("x", function(d) { return d.queue*30 + 300 })
      .attr("y", function(d) { return 400 - d.position*7 })
      .style("opacity", 1)
    rects.exit()
      .transition().ease("linear")
        .attr("y", function(d) { return 500 })
        .style("opacity", 0)

  }

  queuer = rotatingQueue

  for (var i=0; i<20; i++) {
    addPackets(1)
  }

  redraw()
  setInterval(function() {
    for (var i=0; i<8; i++) {
      addPackets(1)
    }
    redraw()
    removePackets()
  }, 1000)


</script>
</body>
</html>
